name: Lighthouse CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  lhci:
    name: Run Lighthouse CI
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      statuses: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: Run Lighthouse CI
        env:
          LHCI_SERVER_BASE_URL: ${{ secrets.LHCI_SERVER_BASE_URL }}
          LHCI_TOKEN: ${{ secrets.LHCI_TOKEN }}
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          lhci autorun --config=lighthouserc.json

      - name: Send Feishu Notification
        if: always()
        run: |
          # è·å– commit ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          
          # åˆ¤æ–­æµ‹è¯•çŠ¶æ€
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_COLOR="green"
            STATUS_TEXT="âœ… æµ‹è¯•é€šè¿‡"
          else
            STATUS_COLOR="red"
            STATUS_TEXT="âŒ æµ‹è¯•å¤±è´¥"
          fi
          
          # æ„å»ºé£ä¹¦æ¶ˆæ¯
          curl -X POST ${{ secrets.FEISHU_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{
              "msg_type": "interactive",
              "card": {
                "header": {
                  "title": {
                    "tag": "plain_text",
                    "content": "ğŸš€ Lighthouse CI æµ‹è¯•æŠ¥å‘Š"
                  },
                  "template": "'"$STATUS_COLOR"'"
                },
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**æµ‹è¯•çŠ¶æ€**: '"$STATUS_TEXT"'\n**åˆ†æ”¯**: '"$BRANCH_NAME"'\n**æäº¤**: '"$COMMIT_HASH"'\n**ä½œè€…**: '"$COMMIT_AUTHOR"'\n**æäº¤ä¿¡æ¯**: '"$COMMIT_MSG"'"
                    }
                  },
                  {
                    "tag": "hr"
                  },
                  {
                    "tag": "action",
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "ğŸ“Š æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š"
                        },
                        "type": "primary",
                        "url": "https://lhci-server-production-1774.up.railway.app/app/projects/lhci-test/dashboard"
                      },
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "ğŸ”— æŸ¥çœ‹ Actions"
                        },
                        "type": "default",
                        "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      }
                    ]
                  }
                ]
              }
            }'
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}