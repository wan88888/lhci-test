name: Lighthouse CI

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    - cron: '0 16 * * 3'
  workflow_dispatch:

jobs:
  lhci:
    name: Run Lighthouse CI
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      statuses: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: Run Lighthouse CI
        env:
          LHCI_SERVER_BASE_URL: ${{ secrets.LHCI_SERVER_BASE_URL }}
          LHCI_TOKEN: ${{ secrets.LHCI_TOKEN }}
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ä¸ºå®šæ—¶ä»»åŠ¡åˆ›å»ºå”¯ä¸€çš„æ„å»ºæ ‡è¯†
          if [ "${{ github.event_name }}" == "schedule" ]; then
            # å®šæ—¶ä»»åŠ¡ï¼šä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€æ ‡è¯†
            BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            BUILD_HASH="scheduled-$(date -u +%Y%m%d-%H%M%S)"
            
            # è®¾ç½®å®Œæ•´çš„æ„å»ºä¸Šä¸‹æ–‡ï¼ˆè¦†ç›–æ‰€æœ‰ Git ä¿¡æ¯ï¼‰
            export LHCI_BUILD_CONTEXT__CURRENT_HASH="$BUILD_HASH"
            export LHCI_BUILD_CONTEXT__COMMIT_MESSAGE="â° å®šæ—¶ä»»åŠ¡ - $BUILD_TIME"
            export LHCI_BUILD_CONTEXT__COMMIT_TIME="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            export LHCI_BUILD_CONTEXT__AUTHOR="GitHub Actions (Scheduled)"
            export LHCI_BUILD_CONTEXT__CURRENT_BRANCH="main"
            export LHCI_BUILD_CONTEXT__AVATAR_URL="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
            export LHCI_BUILD_CONTEXT__EXTERNAL_BUILD_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
            # ç¦ç”¨è‡ªåŠ¨ Git æ£€æµ‹
            export LHCI_BUILD_CONTEXT__GIT_REMOTE=""
            export LHCI_BUILD_CONTEXT__GITHUB_REPO_SLUG="${{ github.repository }}"
            
            echo "ğŸ• å®šæ—¶ä»»åŠ¡æ„å»º"
            echo "ğŸ“¦ Build Hash: $BUILD_HASH"
            echo "â° Build Time: $BUILD_TIME"
            echo "ğŸŒ¿ Branch: main"
          else
            echo "ğŸ“ ä»£ç æäº¤è§¦å‘çš„æ„å»º"
            echo "ğŸŒ¿ Branch: ${GITHUB_REF#refs/heads/}"
          fi
          
          lhci autorun --config=lighthouserc.json

      - name: Send Feishu Notification
        if: always()
        run: |
          # è·å–æ„å»ºä¿¡æ¯
          if [ "${{ github.event_name }}" == "schedule" ]; then
            # å®šæ—¶ä»»åŠ¡
            BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            COMMIT_MSG="â° å®šæ—¶ä»»åŠ¡ - $BUILD_TIME"
            COMMIT_AUTHOR="GitHub Actions (Scheduled)"
            COMMIT_HASH="scheduled-$(date -u +%Y%m%d-%H%M%S)"
            BRANCH_NAME="main"
          else
            # æ­£å¸¸æäº¤
            COMMIT_MSG=$(git log -1 --pretty=%B)
            COMMIT_AUTHOR=$(git log -1 --pretty=%an)
            COMMIT_HASH=$(git rev-parse --short HEAD)
            BRANCH_NAME=${GITHUB_REF#refs/heads/}
          fi
          
          # æ‹¼æ¥ Dashboard URL
          DASHBOARD_URL="${{ secrets.LHCI_SERVER_BASE_URL }}/app/projects/lhci-test/dashboard"
          
          # åˆ¤æ–­æµ‹è¯•çŠ¶æ€
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_COLOR="green"
            STATUS_TEXT="âœ… æµ‹è¯•é€šè¿‡"
          else
            STATUS_COLOR="red"
            STATUS_TEXT="âŒ æµ‹è¯•å¤±è´¥"
          fi
          
          # æ„å»ºé£ä¹¦æ¶ˆæ¯
          curl -X POST ${{ secrets.FEISHU_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{
              "msg_type": "interactive",
              "card": {
                "header": {
                  "title": {
                    "tag": "plain_text",
                    "content": "ğŸš€ eSIM Lighthouseç‰ˆæœ¬å¯¹æ¯”æŠ¥å‘Š"
                  },
                  "template": "'"$STATUS_COLOR"'"
                },
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**æµ‹è¯•çŠ¶æ€**: '"$STATUS_TEXT"'\n**åˆ†æ”¯**: '"$BRANCH_NAME"'\n**æäº¤**: '"$COMMIT_HASH"'\n**ä½œè€…**: '"$COMMIT_AUTHOR"'\n**æäº¤ä¿¡æ¯**: '"$COMMIT_MSG"'"
                    }
                  },
                  {
                    "tag": "hr"
                  },
                  {
                    "tag": "action",
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "ğŸ“Š æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š"
                        },
                        "type": "primary",
                        "url": "'"$DASHBOARD_URL"'"
                      },
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "ğŸ”— æŸ¥çœ‹ Actions"
                        },
                        "type": "default",
                        "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      }
                    ]
                  }
                ]
              }
            }'
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}